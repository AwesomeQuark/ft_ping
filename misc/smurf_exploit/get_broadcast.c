#include <unistd.h>
#include <stdio.h>
#include <strings.h>
#include <string.h>
#include <stdlib.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <netdb.h>
#include <stdbool.h>
#include <arpa/inet.h>

static inline void	print_infos(struct addrinfo *server_infos, char *server, char *ip_)
{
	struct sockaddr_in	*ipv4;
	char			ip[INET6_ADDRSTRLEN];
	struct in_addr		*addr;

	ipv4 = (struct sockaddr_in *)server_infos->ai_addr;
	addr = &ipv4->sin_addr;
	inet_ntop(server_infos->ai_family, addr, ip, sizeof(ip));
	memcpy(ip_, &ip, sizeof(ip));
}

bool	get_ip(char *server, char *ip)
{
	struct addrinfo	*server_infos;

	int err;
	if ((err = getaddrinfo(server, "http", NULL, &server_infos)) != 0
			|| server_infos == NULL)
	{
		fprintf(stderr, "looking up %s: %s\n", server, gai_strerror(err));
		return (false);
	}
	print_infos(server_infos, server, ip);
	return (true);
}

int	main(void)
{
	char	host[32];
	char	file_name[] = "./broadcast.addr";
	int	fd;

	fd = open(file_name, O_WRONLY | O_CREAT, 7777);
	if (fd <= 0)
	{
		perror("open");
		return (EXIT_FAILURE);
	}
	for (int e = 1; e <= 3; e++)
	{
		for (int r = 1; r <= 13; r++)
		{
			for (int p = 1; p <= 23; p++)
			{
				char	tmp[64];
				char	ip[64];

				bzero(tmp, 64);
				bzero(ip, 64);
				sprintf(tmp, "e%dr%dp%d.42.fr", e, r, p);
				if (get_ip(tmp, ip) == true)
				{
					dprintf(fd, "%s\n", ip);
					printf("%s\n", ip);
				}
			}	
		}
	}
}
